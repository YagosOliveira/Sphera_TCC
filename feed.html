<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Feed • Sphera</title>

  <!-- Supabase client -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    // >>>> troque por suas credenciais
    const SUPABASE_URL = "https://ezptlmzxosdssqtwqzrg.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6cHRsbXp4b3Nkc3NxdHdxenJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDkwNDgsImV4cCI6MjA3Mzg4NTA0OH0.rzKy_WfK0Ut6Vc9bm8IbnKTzsFpWgA6b6amW2xgqJec";
    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>
  <style>
    :root{
      --bg:#f6f7f9; --surface:#fff; --muted:#6b7280; --border:#e5e7eb;
      --primary:#dc2626; --shadow:0 2px 8px rgba(0,0,0,.06), 0 12px 28px rgba(0,0,0,.08);
      --radius:16px; --radius-sm:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,sans-serif;
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
    }

    /* topo simples (opcional) */
    .topbar{
      position:sticky; top:0; z-index:10;
      background:#dc2626; color:#fff; height:56px; display:flex; align-items:center;
      box-shadow:0 1px 0 rgba(0,0,0,.06);
    }
    .topbar .wrap{max-width:960px; margin:0 auto; padding:0 16px; width:100%; display:flex; align-items:center; justify-content:space-between;}
    .topbar a{color:#fff; text-decoration:none; font-weight:600}

    .feed-wrap{
      max-width:960px; margin:28px auto 64px; padding:0 16px;
      display:grid; gap:18px;
    }

    .post-card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .post-head{
      display:flex; align-items:center; gap:12px;
      padding:12px 16px; background:#eee; border-bottom:1px solid var(--border);
    }
    .avatar{
      width:44px; height:44px; border-radius:999px; object-fit:cover; flex:0 0 auto;
      background:#fff; border:1px solid var(--border);
    }
    .venue-title{
      display:flex; flex-direction:column; line-height:1.2;
    }
    .venue-title a{
      text-decoration:none; color:#111827; font-size:20px; font-weight:800;
    }
    .venue-title small{ color:var(--muted); }

    .post-body{
      display:grid; grid-template-columns:220px 1fr; gap:16px; padding:16px;
    }
    .post-img{
      width:100%; aspect-ratio:4/3; border-radius:12px; background:#ddd center/cover no-repeat;
      box-shadow:0 2px 10px rgba(0,0,0,.08);
    }
    .post-text{
      color:#374151; font-size:.98rem;
    }
    .post-title{
      color:#111827; font-weight:600; margin-bottom:6px;
    }

    .loadmore{
      display:flex; justify-content:center; margin:12px 0 24px;
    }
    .btn{
      appearance:none; border:1px solid var(--border); background:#fff; color:#111827;
      padding:10px 14px; font-weight:600; border-radius:12px; cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .muted{ color:var(--muted); }

    @media (max-width:720px){
      .post-body{ grid-template-columns:1fr; }
    }
    /* Layout base da navbar (pode manter o que já tinha) */
    .navbar{
      position: sticky;
      top: 0;
      z-index: 30;
      background: #dc2626;
      color: #fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.06);
      min-height: 64px;
      padding-bottom: 0;        /* não precisamos mais de espaço extra */
    }
    .navbar .nav-wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 0 16px;
      height: 64px;
      display: grid;
      grid-template-columns: 1fr auto 1fr; /* brand | center | right */
      align-items: center;
    }
    .navbar .brand{
      font-weight: 800;
      letter-spacing: .04em;
      font-size: 18px;
      color: #fff;
      text-decoration: none;
      justify-self: start;
    }

    /* links centrais */
    .navbar .nav-center{
      justify-self: center;
      display: flex;
      align-items: center;
      gap: 22px;                 /* distância entre link e badge */
    }
    .navbar .nav-link{
      color: #fff;
      text-decoration: none;
      opacity: .95;
      padding: 8px 0;
      border-bottom: 2px solid transparent;
      font-weight: 700;
    }
    .navbar .nav-link:hover{ opacity: 1; }
    .navbar .nav-link.is-active{ border-color: #fff; }

    /* lado direito */
    .navbar .nav-right{
      justify-self: end;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .nav-pill{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.20);
      color:#fff;
      font-weight:600;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      transition: background .15s ease, transform .05s ease, border-color .15s ease;
    }
    .nav-pill:hover{ background: rgba(255,255,255,.16); border-color: rgba(255,255,255,.30); }
    .nav-pill:active{ transform: translateY(1px); }
    .navbar .nav-login{
      background: rgba(255,255,255,.10);
      padding: 8px 12px;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: background .15s ease, transform .05s ease;
    }
    .navbar .nav-login:hover{ background: rgba(255,255,255,.16); }
    .navbar .nav-login:active{ transform: translateY(1px); }

    /* ===== Badge inline entre os links ===== */
    .navbar .nav-badge--inline{
      width: 48px;               /* tamanho do círculo */
      height: 48px;
      border-radius: 999px;
      background: rgba(0,0,0,.06);   /* leve realce; opcional */
      border: 2px solid rgba(150, 22, 22, 0.35);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 18px rgba(0,0,0,.12);
      pointer-events: none;      /* não captura cliques; links continuam clicáveis */
    }
    .navbar .nav-badge--inline img{
      width: 24px;
      height: 24px;
      display: block;
        /* deixa a logo branca */
    }

    /* responsivo */
    @media (max-width: 720px){
      .navbar .nav-center{ gap: 16px; }
      .navbar .nav-badge--inline{
      width: 44px; height: 44px;
      }
      .navbar .nav-badge--inline img{
        width: 22px; height: 22px;
      }
    }
  </style>

  
</head>
<body>
  <div class="navbar">
    <div class="nav-wrap" role="navigation" aria-label="Barra de navegação">
      <a class="brand" href="/">SPHERA</a>

      <!-- NAV central com o badge inline entre os links -->
      <nav class="nav-center">
        <a href="/index.html" class="nav-link" data-key="menu">Mapa</a>

        <!-- badge inline -->
        <span class="nav-badge nav-badge--inline" aria-hidden="true">
          <img src="./assets/images/logo.png" alt="">
        </span>

        <a href="/feed.html" class="nav-link" data-key="feed">Feed</a>
      </nav>

      <div class="nav-right">
        <button id="btnPerfil" class="nav-pill" title="Seu perfil">Perfil</button>
        <a class="nav-login" href="/login.html">Login</a>
      </div>
    </div>
  </div>

  <main class="feed-wrap" id="feed"></main>
  <div class="loadmore"><button class="btn" id="btnMore">Carregar mais</button></div>

  <script type="module">
      const $ = (s, p=document) => p.querySelector(s);
      const feedEl  = $('#feed');
      const btnMore = $('#btnMore');

      function timeAgo(iso){
        if(!iso) return '';
        const d = new Date(iso);
        const diff = (Date.now() - d.getTime())/1000;
        if(diff < 60) return 'agora pouco';
        if(diff < 3600) return `${Math.floor(diff/60)} min`;
        if(diff < 86400) return `${Math.floor(diff/3600)} h`;
        return d.toLocaleDateString();
      }

      const PAGE_SIZE = 9;
      let page = 0, loading = false, finished = false;

      function showNoPosts(){
        if (!document.getElementById('noPostsMsg')) {
          const p = document.createElement('p');
          p.id = 'noPostsMsg';
          p.className = 'muted';
          p.textContent = 'Ainda não há postagens.';
          feedEl.appendChild(p);
        }
      }
      function hideNoPosts(){
        document.getElementById('noPostsMsg')?.remove();
      }

      async function fetchPage(){
        if (loading || finished) return [];
        loading = true;

        const from = page * PAGE_SIZE;
        const to   = from + PAGE_SIZE - 1;

        const { data, error } = await supabase
          .from('posts')
          .select(`id,title,body,image_url,created_at,
                  venue:venue_id (id,name,slug,logo_url)`)
          .eq('published', true)
          .order('created_at', { ascending:false })
          .range(from, to);

        loading = false;
        if (error) { console.error('[feed] erro:', error); return []; }
        if (!data || data.length < PAGE_SIZE) finished = true;
        page++;
        return data || [];
      }

      function renderPosts(posts){
        if (!posts || posts.length === 0) {
          if (feedEl.children.length === 0) showNoPosts();
          return;
        }
        hideNoPosts();

        for (const p of posts){
          const v = p.venue || {};
          const a = document.createElement('article');
          a.className = 'post-card';
          a.innerHTML = `
            <div class="post-head">
              <img class="avatar" src="${v.logo_url || ''}" alt="">
              <div class="venue-title">
                <a href="/profile.html?slug=${encodeURIComponent(v.slug || '')}">
                  ${v.name || 'Estabelecimento'}
                </a>
                <small class="muted">${timeAgo(p.created_at)}</small>
              </div>
            </div>
            <div class="post-body">
              ${p.image_url
                ? `<div class="post-img" style="background-image:url('${p.image_url}')"></div>`
                : `<div class="post-img" style="background:#f1f5f9"></div>`}
              <div class="post-text">
                <div class="post-title">${p.title || ''}</div>
                <div>${p.body || ''}</div>
              </div>
            </div>`;
          feedEl.appendChild(a);
        }
      }

      async function loadMore(){
        const rows = await fetchPage();
        renderPosts(rows);
        if (finished) btnMore.style.display = 'none';
      }

      // ---- NOVO: completa a tela automaticamente
      async function ensureFilled(){
        // evita loop infinito com um limite de iterações
        let guard = 8;
        while (!finished && document.documentElement.scrollHeight < (window.innerHeight - 120) && guard-- > 0) {
          await loadMore();
          // aguarda um frame para recalcular a altura
          await new Promise(r => requestAnimationFrame(r));
        }
      }

      // ---- IntersectionObserver (continua útil pra rolagem)
      let io;
      function attachIO(){
        io?.disconnect();
        io = new IntersectionObserver(entries=>{
          if (entries.some(e => e.isIntersecting)) loadMore();
        }, { rootMargin: '300px 0px', threshold: 0.01 });
        io.observe(btnMore);
      }

      // ---- BOOT
      document.addEventListener('DOMContentLoaded', async ()=>{
        await loadMore();     // sempre carrega 1 página
        await ensureFilled(); // e completa a tela se precisar
        attachIO();
      });

      // clique manual
      btnMore.addEventListener('click', async ()=>{
        await loadMore();
        await ensureFilled();
      });

      // se a janela mudar (ou navbar reflow), revalida
      window.addEventListener('resize', async ()=>{
        await ensureFilled();
        attachIO();
      });

      async function updateRight(host){
        const right = host.querySelector(".nav-right");
        if (!right) return;

        const supabase = window.supabase;
        if (!supabase) { // sem supabase → mostra Login
          right.innerHTML = `<a class="nav-login" href="/login.html">Login</a>`;
          return;
        }

        const { data: { user } = {} } = await supabase.auth.getUser();
        if (!user) {
          right.innerHTML = `<a class="nav-login" href="/login.html">Login</a>`;
          return;
        }

        try {
          const { data } = await supabase
            .from("profiles")
            .select("role,name")
            .eq("id", user.id)
            .single();
          const role = (data?.role || "USER").toUpperCase();
          const initial = (data?.name?.trim()?.[0] || user.email?.[0] || "U").toUpperCase();
          const profileLink = role === "OWNER" ? "/owner.html" : "/user.html";
          right.innerHTML = `<a class="nav-login" href="${profileLink}" title="Seu perfil"><span class="nav-avatar">${initial}</span></a>`;
        } catch {
          right.innerHTML = `<a class="nav-login" href="/user.html"><span class="nav-avatar">U</span></a>`;
        }
      }
      // chama updateRight assim que o supabase existir (ou já de cara)
      function tryUpdateRight(host){
        if (window.supabase) return updateRight(host);
        // espera um pouco pelo client do head (2s máx)
        let tries = 0;
        const id = setInterval(() => {
          tries++;
          if (window.supabase || tries > 20){ // 20 * 100ms = 2s
            clearInterval(id);
            updateRight(host);
          }
        }, 100);
      }

      // escuta mudanças de auth quando disponível
      function startAuthWatcher(host){
        if (!window.supabase) {
          // tenta de novo em 500ms
          setTimeout(() => startAuthWatcher(host), 500);
          return;
        }
        window.supabase.auth.onAuthStateChange(() => updateRight(host));
      }
      
  </script>


  
</body>
</html>
