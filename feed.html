<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Feed • Sphera</title>

  <style>
    :root{
      --bg:#f6f7f9; --surface:#fff; --muted:#6b7280; --border:#e5e7eb;
      --primary:#dc2626; --shadow:0 2px 8px rgba(0,0,0,.06), 0 12px 28px rgba(0,0,0,.08);
      --radius:16px; --radius-sm:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,sans-serif;
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
    }

    /* topo simples (opcional) */
    .topbar{
      position:sticky; top:0; z-index:10;
      background:#dc2626; color:#fff; height:56px; display:flex; align-items:center;
      box-shadow:0 1px 0 rgba(0,0,0,.06);
    }
    .topbar .wrap{max-width:960px; margin:0 auto; padding:0 16px; width:100%; display:flex; align-items:center; justify-content:space-between;}
    .topbar a{color:#fff; text-decoration:none; font-weight:600}

    .feed-wrap{
      max-width:960px; margin:28px auto 64px; padding:0 16px;
      display:grid; gap:18px;
    }

    .post-card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .post-head{
      display:flex; align-items:center; gap:12px;
      padding:12px 16px; background:#eee; border-bottom:1px solid var(--border);
    }
    .avatar{
      width:44px; height:44px; border-radius:999px; object-fit:cover; flex:0 0 auto;
      background:#fff; border:1px solid var(--border);
    }
    .venue-title{
      display:flex; flex-direction:column; line-height:1.2;
    }
    .venue-title a{
      text-decoration:none; color:#111827; font-size:20px; font-weight:800;
    }
    .venue-title small{ color:var(--muted); }

    .post-body{
      display:grid; grid-template-columns:220px 1fr; gap:16px; padding:16px;
    }
    .post-img{
      width:100%; aspect-ratio:4/3; border-radius:12px; background:#ddd center/cover no-repeat;
      box-shadow:0 2px 10px rgba(0,0,0,.08);
    }
    .post-text{
      color:#374151; font-size:.98rem;
    }
    .post-title{
      color:#111827; font-weight:600; margin-bottom:6px;
    }

    .loadmore{
      display:flex; justify-content:center; margin:12px 0 24px;
    }
    .btn{
      appearance:none; border:1px solid var(--border); background:#fff; color:#111827;
      padding:10px 14px; font-weight:600; border-radius:12px; cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .muted{ color:var(--muted); }

    @media (max-width:720px){
      .post-body{ grid-template-columns:1fr; }
    }
  </style>

  <!-- Supabase client -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    // >>>> troque por suas credenciais
    const SUPABASE_URL = "https://ezptlmzxosdssqtwqzrg.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6cHRsbXp4b3Nkc3NxdHdxenJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDkwNDgsImV4cCI6MjA3Mzg4NTA0OH0.rzKy_WfK0Ut6Vc9bm8IbnKTzsFpWgA6b6amW2xgqJec";
    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>
</head>
<body>

  <div class="topbar">
    <div class="wrap">
      <a href="/">SPHERA</a>
      <nav style="display:flex; gap:16px;">
        <a href="/menu.html" class="muted">Menu</a>
        <a href="/feed.html" style="font-weight:800">Feed</a>
        <a href="/login.html" class="muted">Login</a>
      </nav>
    </div>
  </div>

  <main class="feed-wrap" id="feed"></main>
  <div class="loadmore"><button class="btn" id="btnMore">Carregar mais</button></div>

  <script type="module">
    /* -------- utils -------- */
    const $ = (s, p=document) => p.querySelector(s);
    const feedEl   = $('#feed');
    const btnMore  = $('#btnMore');

    function timeAgo(iso){
      if(!iso) return '';
      const d = new Date(iso);
      const diff = (Date.now() - d.getTime())/1000;
      if(diff < 60)   return 'agora pouco';
      if(diff < 3600) return `${Math.floor(diff/60)} min`;
      if(diff < 86400) return `${Math.floor(diff/3600)} h`;
      return d.toLocaleDateString();
    }

    /* -------- data/pagination -------- */
    const PAGE_SIZE = 9;
    let page = 0, loading = false, finished = false;

    function showNoPosts(){
        if (!document.getElementById('noPostsMsg')) {
        const p = document.createElement('p');
        p.id = 'noPostsMsg';
        p.className = 'muted';
        p.textContent = 'Ainda não há postagens.';
        feedEl.appendChild(p);
        }
    }
    function hideNoPosts(){
        const n = document.getElementById('noPostsMsg');
        if (n) n.remove();
    }

    async function fetchPage(){
        if (loading || finished) return [];
        loading = true;

        const from = page * PAGE_SIZE;
        const to   = from + PAGE_SIZE - 1;

        const { data, error } = await supabase
        .from('posts')
        .select(`id,title,body,image_url,created_at,
                venue:venue_id (id,name,slug,logo_url)`)
        .eq('published', true)
        .order('created_at', { ascending:false })
        .range(from, to);

        loading = false;
        if (error) { console.error(error); return []; }
        if (!data || data.length < PAGE_SIZE) finished = true;
        page++;
        return data || [];
    }

    function renderPosts(posts){
        if (!posts || posts.length === 0) {
        // só mostra o placeholder se ainda não há nada na tela
        if (feedEl.children.length === 0) showNoPosts();
        return;
        }

        // vieram posts => some com o placeholder
        hideNoPosts();

        posts.forEach(p=>{
        const v = p.venue || {};
        const a = document.createElement('article');
        a.className = 'post-card';
        a.innerHTML = `
            <div class="post-head">
            <img class="avatar" src="${v.logo_url || ''}" alt="">
            <div class="venue-title">
                <a href="/profile.html?slug=${encodeURIComponent(v.slug || '')}">
                ${v.name || 'Estabelecimento'}
                </a>
                <small class="muted">${timeAgo(p.created_at)}</small>
            </div>
            </div>
            <div class="post-body">
            ${p.image_url
                ? `<div class="post-img" style="background-image:url('${p.image_url}')"></div>`
                : `<div class="post-img" style="background:#f1f5f9"></div>`}
            <div class="post-text">
                <div class="post-title">${p.title || ''}</div>
                <div>${p.body || ''}</div>
            </div>
            </div>`;
        feedEl.appendChild(a);
        });
    }

    async function loadMore(){
        const rows = await fetchPage();
        renderPosts(rows);
        if (finished) btnMore.style.display = 'none';
    }

    // boot
    loadMore();
    btnMore.addEventListener('click', loadMore);

    const io = new IntersectionObserver(entries=>{
        entries.forEach(e=>{ if (e.isIntersecting) loadMore(); });
    }, { rootMargin: '600px' });
    io.observe(btnMore);
    </script>
</body>
</html>
