<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel do Estabelecimento</title>
  <link rel="stylesheet" href="./styleowner.css" />

  <!-- Supabase client -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    window.supabase = createClient(
      "https://ezptlmzxosdssqtwqzrg.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6cHRsbXp4b3Nkc3NxdHdxenJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDkwNDgsImV4cCI6MjA3Mzg4NTA0OH0.rzKy_WfK0Ut6Vc9bm8IbnKTzsFpWgA6b6amW2xgqJec"
    );
  </script>
</head>
<body class="">
  <div class="wrap">
    <div class="card">
      <div class="bar">
        <h1>Cadastro/edição do Estabelecimento</h1>
        <button class="btn" id="btnSave">Salvar</button>
      </div>

      <form id="formVenue">
        <label>Nome</label>
        <input name="name" required />

        <div class="cols">
          <div>
            <label>Categoria</label>
            <input name="category" placeholder="cafe, bar, parque..." />
          </div>
          <div>
            <label>Preço médio (R$)</label>
            <input name="avg_price" type="number" step="0.01" />
          </div>
        </div>

        <div class="cols">
          <div>
            <label>Status</label>
            <select name="status">
              <option value="aberto">Aberto</option>
              <option value="fechado">Fechado</option>
            </select>
          </div>
          <div>
            <label>Nota (0–5)</label>
            <input name="rating" type="number" step="0.1" min="0" max="5" />
          </div>
        </div>

        <label>Endereço</label>
        <input name="address" />

        <div class="cols">
          <div>
            <label>Latitude</label>
            <input name="lat" type="number" step="0.000001" />
          </div>
          <div>
            <label>Longitude</label>
            <input name="lng" type="number" step="0.000001" />
          </div>
        </div>

        <label>URL da imagem (opcional)</label>
        <input name="image_url" placeholder="https://..." />

        <label>Diferenciais</label>
        <div id="featuresBox" class="features"><em class="msg">carregando...</em></div>

        <p class="msg" id="statusMsg"></p>
      </form>
    </div>
  </div>

  <script type="module">
    const form = document.getElementById('formVenue');
    const btnSave = document.getElementById('btnSave');
    const featuresBox = document.getElementById('featuresBox');
    const statusMsg = document.getElementById('statusMsg');

    const { data:{ user } } = await supabase.auth.getUser();
    if (!user) {
      location.href = '/login.html';
    }

    // 1) checa se é OWNER
    const { data: prof, error: profErr } = await supabase
      .from('profiles').select('role').eq('id', user.id).single();
    if (profErr || !prof || prof.role !== 'OWNER') {
      alert('Apenas estabelecimentos (OWNER) podem acessar.');
      location.href = '/';
    }

    // 2) carrega catálogo de features
    const { data: feats, error: featErr } = await supabase
      .from('features').select('id, slug, label').order('label');
    if (featErr) {
      featuresBox.innerHTML = '<span class="msg">Erro ao carregar diferenciais.</span>';
    } else {
      featuresBox.innerHTML = feats.map(f => `
        <label class="chip">
          <input type="checkbox" name="features" value="${f.slug}"> ${f.label}
        </label>
      `).join('');
    }

    // 3) carrega (se existir) o venue do dono para edição
    let currentVenue = null;
    {
      const { data: v } = await supabase
        .from('venues')
        .select('id, name, category, avg_price, status, rating, lat, lng, address, image_url')
        .eq('owner_id', user.id)
        .single();
      if (v) {
        currentVenue = v;
        form.name.value       = v.name ?? '';
        form.category.value   = v.category ?? '';
        form.avg_price.value  = v.avg_price ?? '';
        form.status.value     = v.status ?? 'aberto';
        form.rating.value     = v.rating ?? '';
        form.address.value    = v.address ?? '';
        form.lat.value        = v.lat ?? '';
        form.lng.value        = v.lng ?? '';
        form.image_url.value  = v.image_url ?? '';

        // marca features existentes (via view que traz slugs)
        const { data: currFeats } = await supabase
          .from('venue_features_view')   // view que criamos
          .select('slug')
          .eq('venue_id', v.id);

        const slugs = (currFeats || []).map(x => x.slug);
        featuresBox.querySelectorAll('input[name="features"]').forEach(chk => {
          chk.checked = slugs.includes(chk.value);
        });
      }
    }

    // 4) salvar
    btnSave.addEventListener('click', async (e) => {
      e.preventDefault();
      statusMsg.textContent = 'Salvando...';

      const fd = new FormData(form);
      const payload = {
        owner_id: user.id,          // RLS exige = auth.uid()
        name: fd.get('name') || null,
        category: fd.get('category') || null,
        avg_price: fd.get('avg_price') ? Number(fd.get('avg_price')) : null,
        status: fd.get('status') || 'aberto',
        rating: fd.get('rating') ? Number(fd.get('rating')) : null,
        lat: fd.get('lat') ? Number(fd.get('lat')) : null,
        lng: fd.get('lng') ? Number(fd.get('lng')) : null,
        address: fd.get('address') || null,
        image_url: fd.get('image_url') || null
      };

      let venue = currentVenue;
      if (!venue) {
        const { data, error } = await supabase.from('venues').insert([payload]).select().single();
        if (error) { statusMsg.textContent = 'Erro: ' + error.message; statusMsg.style.color = '#b91c1c'; return; }
        venue = data;
        currentVenue = data;
      } else {
        const { data, error } = await supabase.from('venues')
          .update(payload).eq('id', venue.id).select().single();
        if (error) { statusMsg.textContent = 'Erro: ' + error.message; statusMsg.style.color = '#b91c1c'; return; }
        venue = data;
      }

      // 5) salva diferenciais usando a RPC add_feature (trabalha por slug)
      // estratégia simples: limpar todos e re-add conforme marcados
      await supabase.from('venue_features').delete().eq('venue_id', venue.id);

      const selectedSlugs = [...featuresBox.querySelectorAll('input[name="features"]:checked')]
        .map(i => i.value);

      await Promise.all(selectedSlugs.map(slug =>
        supabase.rpc('add_feature', { venue: venue.id, feat_slug: slug })
      ));

      statusMsg.textContent = 'Salvo com sucesso!';
      statusMsg.style.color = '#065f46';
      // opcional: redirecionar
      // location.href = '/';
    });
  </script>
</body>
</html>
