<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Redefinir senha • Sphera</title>
  <link rel="stylesheet" href="./stylelogin.css" />

  <!-- Supabase client -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    window.supabase = createClient(
      "https://ezptlmzxosdssqtwqzrg.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6cHRsbXp4b3Nkc3NxdHdxenJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDkwNDgsImV4cCI6MjA3Mzg4NTA0OH0.rzKy_WfK0Ut6Vc9bm8IbnKTzsFpWgA6b6amW2xgqJec"
    );
  </script>
</head>
<body>
  <!-- (Opcional) Se quiser, copie aqui a mesma navbar do login -->

  <main class="auth-page">
    <form id="formReset" class="card">
      <h2>Redefinir senha</h2>
      <p class="hint">Digite sua nova senha abaixo para acessar o Sphera novamente.</p>

      <input
        id="newPassword"
        type="password"
        placeholder="Nova senha..."
        minlength="6"
        required
      />
      <button class="btn primary" id="btnReset">Salvar nova senha</button>

      <p class="meta" id="resetMsg" style="display:none;margin-top:8px;"></p>
    </form>
  </main>

  <script type="module">
    const formReset = document.getElementById('formReset');
    const resetMsg  = document.getElementById('resetMsg');
    const btnReset  = document.getElementById('btnReset');

    function setLoadingReset(loading) {
      if (!btnReset) return;
      btnReset.disabled = loading;
      btnReset.textContent = loading ? 'Salvando...' : 'Salvar nova senha';
    }

    formReset?.addEventListener('submit', async (e) => {
      e.preventDefault();
      resetMsg.style.display = 'none';
      setLoadingReset(true);

      const newPassword = document.getElementById('newPassword').value;

      // Garante que existe um usuário na sessão (vindo do link de recuperação)
      const { data: { user }, error: getUserError } = await supabase.auth.getUser();

      if (!user || getUserError) {
        setLoadingReset(false);
        resetMsg.textContent = 'Link de recuperação inválido ou expirado. Peça um novo link na tela de login.';
        resetMsg.style.color = '#b91c1c';
        resetMsg.style.display = 'block';
        return;
      }

      const { error } = await supabase.auth.updateUser({ password: newPassword });

      setLoadingReset(false);

      if (error) {
        console.error(error);
        resetMsg.textContent = 'Erro ao atualizar a senha. Tente novamente.';
        resetMsg.style.color = '#b91c1c';
      } else {
        resetMsg.textContent = 'Senha alterada com sucesso! Você já pode fazer login.';
        resetMsg.style.color = '#065f46';

        // Redireciona para a tela de login depois de 2s
        setTimeout(() => {
          window.location.href = '/login.html';
        }, 2000);
      }
      resetMsg.style.display = 'block';
    });
  </script>
</body>
</html>
