<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meu Perfil • Sphera</title>
  <style>
    :root{ --bg:#f6f7f9; --surface:#fff; --border:#e5e7eb; --muted:#6b7280; --primary:#dc2626; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,sans-serif;color:#0f172a}
    .wrap{max-width:860px;margin:40px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    h1{margin:0 0 12px}
    label{display:block;margin:10px 0 6px;font-weight:600}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font:inherit}
    .cols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{appearance:none;border:0;background:var(--primary);color:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:700}
    .chips{display:flex;flex-wrap:wrap;gap:10px}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:8px 12px;background:#fff}
    .bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center}
    .avatar{width:64px;height:64px;border-radius:999px;object-fit:cover;border:1px solid var(--border)}
    
    /* Layout base da navbar (pode manter o que já tinha) */
    .navbar{
      position: sticky;
      top: 0;
      z-index: 30;
      background: #dc2626;
      color: #fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.06);
      min-height: 64px;
      padding-bottom: 0;        /* não precisamos mais de espaço extra */
    }
    .navbar .nav-wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 0 16px;
      height: 64px;
      display: grid;
      grid-template-columns: 1fr auto 1fr; /* brand | center | right */
      align-items: center;
    }
    .navbar .brand{
      font-weight: 800;
      letter-spacing: .04em;
      font-size: 18px;
      color: #fff;
      text-decoration: none;
      justify-self: start;
    }

    /* links centrais */
    .navbar .nav-center{
      justify-self: center;
      display: flex;
      align-items: center;
      gap: 22px;                 /* distância entre link e badge */
    }
    .navbar .nav-link{
      color: #fff;
      text-decoration: none;
      opacity: .95;
      padding: 8px 0;
      border-bottom: 2px solid transparent;
      font-weight: 700;
    }
    .navbar .nav-link:hover{ opacity: 1; }
    .navbar .nav-link.is-active{ border-color: #fff; }

    /* lado direito */
    .navbar .nav-right{
      justify-self: end;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .nav-pill{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.20);
      color:#fff;
      font-weight:600;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      transition: background .15s ease, transform .05s ease, border-color .15s ease;
    }
    .nav-pill:hover{ background: rgba(255,255,255,.16); border-color: rgba(255,255,255,.30); }
    .nav-pill:active{ transform: translateY(1px); }
    .navbar .nav-login{
      background: rgba(255,255,255,.10);
      padding: 8px 12px;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: background .15s ease, transform .05s ease;
    }
    .navbar .nav-login:hover{ background: rgba(255,255,255,.16); }
    .navbar .nav-login:active{ transform: translateY(1px); }

    /* ===== Badge inline entre os links ===== */
    .navbar .nav-badge--inline{
      width: 48px;               /* tamanho do círculo */
      height: 48px;
      border-radius: 999px;
      background: rgba(0,0,0,.06);   /* leve realce; opcional */
      border: 2px solid rgba(150, 22, 22, 0.35);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 18px rgba(0,0,0,.12);
      pointer-events: none;      /* não captura cliques; links continuam clicáveis */
    }
    .navbar .nav-badge--inline img{
      width: 24px;
      height: 24px;
      display: block;
        /* deixa a logo branca */
    }
    .btn-upload{
      display:inline-block;
      padding:8px 12px;
      border-radius:10px;
      background:#e5e7eb;
      cursor:pointer;
      font-size:0.9rem;
      font-weight:600;
    }
    .btn-upload:hover{ background:#d1d5db; }

    /* responsivo */
    @media (max-width: 720px){
      .navbar .nav-center{ gap: 16px; }
      .navbar .nav-badge--inline{
      width: 44px; height: 44px;
      }
      .navbar .nav-badge--inline img{
        width: 22px; height: 22px;
      }
    }
    @media (max-width:680px){ .cols{grid-template-columns:1fr} }
  </style>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const supabase = createClient(
      "https://ezptlmzxosdssqtwqzrg.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6cHRsbXp4b3Nkc3NxdHdxenJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDkwNDgsImV4cCI6MjA3Mzg4NTA0OH0.rzKy_WfK0Ut6Vc9bm8IbnKTzsFpWgA6b6amW2xgqJec"
    );

    const $ = (s,p=document)=>p.querySelector(s);

    let userId = null;
    let featureCatalog = [];
    let prefMap = new Map(); // slug -> weight

    async function ensureAuth(){
      const { data:{ user } } = await supabase.auth.getUser();
      if (!user){ location.href = "/login.html"; return; }
      userId = user.id;
      $("#email").value = user.email || "";
    }

    async function loadProfile(){
      const { data } = await supabase.from("profiles")
        .select("name,birth_date,avatar_url,bio,home_lat,home_lng,max_distance_km,budget_level,fav_categories")
        .eq("id", userId).single();
      if (!data) return;
      $("#name").value = data.name || "";
      $("#birth").value = data.birth_date || "";
      $("#bio").value = data.bio || "";
      $("#home_lat").value = data.home_lat ?? "";
      $("#home_lng").value = data.home_lng ?? "";
      $("#max_dist").value = data.max_distance_km ?? 10;
      $("#budget").value = data.budget_level ?? "";
      $("#categories").value = (data.fav_categories || []).join(", ");
      if (data.avatar_url){
        $("#avatar").src = data.avatar_url;
      }
    }

    async function loadFeatures(){
      const { data } = await supabase.from("features").select("id,slug,label").order("label");
      featureCatalog = data || [];
      // montar chips com select de peso
      const box = $("#prefs");
      box.innerHTML = featureCatalog.map(f => `
        <label class="chip">
          <input type="checkbox" data-slug="${f.slug}" />
          ${f.label}
          <select data-slug="${f.slug}" style="border:1px solid #e5e7eb;border-radius:8px;padding:4px">
            <option value="1">+1</option>
            <option value="2">+2</option>
            <option value="3">+3</option>
            <option value="4">+4</option>
            <option value="5">+5</option>
          </select>
        </label>
      `).join("");
      await loadUserPrefs();
    }

    async function loadUserPrefs(){
      // traz (feature_id, weight) e marca os chips
      const { data } = await supabase
        .from("user_feature_prefs")
        .select("feature_id, weight")
        .eq("user_id", userId);
      const byId = new Map((data||[]).map(r => [r.feature_id, r.weight]));
      prefMap.clear();

      featureCatalog.forEach(f => {
        const checked = byId.has(f.id);
        const w = byId.get(f.id) || 1;
        const chk = $(`input[type=checkbox][data-slug="${f.slug}"]`);
        const sel = $(`select[data-slug="${f.slug}"]`);
        if (chk){ chk.checked = checked; }
        if (sel){ sel.value = String(w); }
        if (checked) prefMap.set(f.slug, w);
      });
    }

    async function saveProfile(){
      const payload = {
        name: $("#name").value.trim() || null,
        birth_date: $("#birth").value || null,
        bio: $("#bio").value.trim() || null,
        home_lat: $("#home_lat").value ? Number($("#home_lat").value) : null,
        home_lng: $("#home_lng").value ? Number($("#home_lng").value) : null,
        max_distance_km: $("#max_dist").value ? Number($("#max_dist").value) : 10,
        budget_level: $("#budget").value ? Number($("#budget").value) : null,
        fav_categories: $("#categories").value
          ? $("#categories").value.split(",").map(s=>s.trim()).filter(Boolean)
          : null
      };
      const { error } = await supabase.from("profiles").update(payload).eq("id", userId);
      if (error) return alert("Erro ao salvar perfil: " + error.message);
      alert("Perfil salvo!");
    }

    async function savePrefs(){
      // lê cada chip e salva via upsert (chame a RPC por slug ou manipule direto por id)
      const ops = [];
      featureCatalog.forEach(f => {
        const chk = $(`input[type=checkbox][data-slug="${f.slug}"]`);
        const sel = $(`select[data-slug="${f.slug}"]`);
        const w = Number(sel?.value || 1);
        if (chk?.checked){
          // upsert por id
          ops.push(
            supabase.from("user_feature_prefs").upsert({
              user_id: userId, feature_id: f.id, weight: w
            })
          );
        } else {
          // se existir e desmarcou, remove
          ops.push(
            supabase.from("user_feature_prefs")
              .delete().eq("user_id", userId).eq("feature_id", f.id)
          );
        }
      });
      await Promise.all(ops);
      alert("Preferências salvas!");
    }

    // pegar geolocalização do navegador
    $("#btnGeo")?.addEventListener("click", ()=>{
      if (!navigator.geolocation) return alert("Geolocalização indisponível.");
      navigator.geolocation.getCurrentPosition(pos=>{
        $("#home_lat").value = pos.coords.latitude.toFixed(6);
        $("#home_lng").value = pos.coords.longitude.toFixed(6);
      }, err=>{
        alert("Não foi possível obter sua localização.");
      }, { enableHighAccuracy:true, maximumAge:30000, timeout:10000 });
    });

    // sobe a imagem pro bucket 'avatars' e atualiza profiles.avatar_url
      async function uploadAvatar(file){
        if (!userId) throw new Error("Usuário não autenticado.");

        /* validação básica de tamanho (2 MB)
        const maxSize = 2 * 1024 * 1024;
        if (file.size > maxSize){
          throw new Error("Escolha uma imagem de até 2 MB.");
        }*/

        const ext = file.name.split(".").pop();
        const fileName = `${userId}-${Date.now()}.${ext}`;
        const filePath = `${userId}/${fileName}`;

        // upload no bucket 'avatars'
        const { error: uploadError } = await supabase.storage
          .from("avatars")
          .upload(filePath, file, { upsert: true });

        if (uploadError) throw uploadError;

        // pega URL pública
        const { data } = supabase.storage.from("avatars").getPublicUrl(filePath);
        const publicUrl = data.publicUrl;

        // grava no profiles
        const { error: updateError } = await supabase
          .from("profiles")
          .update({ avatar_url: publicUrl })
          .eq("id", userId);

        if (updateError) throw updateError;

        return publicUrl;
      }

      // handler do input de arquivo
      async function handleAvatarChange(e){
        const file = e.target.files?.[0];
        if (!file) return;

        try{
          // preview rápido com blob local
          const previewUrl = URL.createObjectURL(file);
          $("#avatar").src = previewUrl;

          const finalUrl = await uploadAvatar(file);
          // depois que subir, garante que está usando a URL pública
          $("#avatar").src = finalUrl;
        }catch(err){
          console.error(err);
          alert("Erro ao enviar imagem: " + err.message);
        }finally{
          e.target.value = ""; // limpa input
        }
      }

    // fluxo
    (async function boot(){
      await ensureAuth();
      await Promise.all([loadProfile(), loadFeatures()]);
      $("#btnSave").addEventListener("click", saveProfile);
      $("#btnSavePrefs").addEventListener("click", savePrefs);
      const avatarInput = $("#avatarFile");
      if (avatarInput){
        avatarInput.addEventListener("change", handleAvatarChange);
      }
    })();
    
    const btnProfile = document.getElementById('btnPerfil');

    btnProfile?.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError) throw userError;

        // Sem sessão → manda pro login
        if (!user) {
          location.href = '/login.html';
          return;
        }

        // 1) Descobrir a role
        const { data: prof, error: profError } = await supabase
          .from('profiles')
          .select('role')
          .eq('id', user.id)
          .single();

        if (profError) {
          console.warn('[perfil] erro buscando role, caindo em /user.html', profError);
          location.href = '/user.html';
          return;
        }

        const role = (prof?.role || 'USER').toUpperCase();

        // 2) Se não for OWNER → perfil de usuário normal
        if (role !== 'OWNER') {
          location.href = '/user.html';
          return;
        }

        // 3) Se for OWNER → buscar slug/id do estabelecimento
        // TROQUE "places" e "owner_id" se os nomes da sua tabela forem outros
        const { data: places, error: placeError } = await supabase
          .from('venues')            // ex.: tabela de estabelecimentos
          .select('id, slug')        // campos que você precisa
          .eq('owner_id', user.id)   // FK para o dono
          .limit(1);

        if (placeError) {
          console.warn('[perfil] erro buscando estabelecimento do owner, indo para /owner.html', placeError);
          location.href = '/owner.html'; // fallback: painel do dono
          return;
        }

        const place = places?.[0];

        if (!place) {
          // Dono ainda não cadastrou estabelecimento → manda pro painel pra configurar
          location.href = '/owner.html';
          return;
        }

        // 4) Montar URL de perfil do dono
        // Troque "/owner-profile.html" pela sua página de perfil público
        const basePath = '/profile.html';

        const url =`${basePath}?slug=${encodeURIComponent(place.slug)}`;
      ;

        location.href = url;
      } catch (err) {
        console.error('[perfil] erro inesperado', err);
        // fallback seguro
        location.href = '/user.html';
      }
    });
  </script>
</head>
<body>
  
  <div class="navbar">
    <div class="nav-wrap" role="navigation" aria-label="Barra de navegação">
      <a class="brand" href="/">SPHERA</a>

      <!-- NAV central com o badge inline entre os links -->
      <nav class="nav-center">
        <a href="/index.html" class="nav-link" data-key="menu">Mapa</a>

        <!-- badge inline -->
        <span class="nav-badge nav-badge--inline" aria-hidden="true">
          <img src="./assets/images/logo.png" alt="">
        </span>

        <a href="/feed.html" class="nav-link" data-key="feed">Feed</a>
      </nav>

      <div class="nav-right">
        <button id="btnPerfil" class="nav-pill" title="Seu perfil">Perfil</button>
        <a class="nav-login" href="/login.html">Login</a>
      </div>
    </div>
  </div>
  <div class="wrap">
    <div class="card">
      <div class="bar">
        <h1>Meu perfil</h1>
        <button class="btn" id="btnSave">Salvar</button>
      </div>

      <div class="row">
        <img id="avatar" class="avatar" src="" alt="">

        <div>
          <label class="btn-upload">
            Escolher foto
            <input type="file" id="avatarFile" accept="image/*" hidden />
          </label>
          <div class="muted">Sua foto </div>
        </div>
      </div>

      <div class="cols" style="margin-top:12px">
        <div>
          <label>Nome</label>
          <input id="name" />
        </div>
        <div>
          <label>E-mail</label>
          <input id="email" disabled />
        </div>
      </div>

      <div class="cols">
        <div>
          <label>Data de nascimento</label>
          <input id="birth" type="date" />
        </div>
        <div>
          <label>Orçamento Médio</label>
          <input id="budget" type="number" />
        </div>
      </div>

      <label>Bio</label>
      <textarea id="bio" rows="3" placeholder="Fale um pouco sobre você..."></textarea>

      <div class="cols">
        <div>
          <label>Latitude</label>
          <input id="home_lat" type="number" step="0.000001" />
        </div>
        <div>
          <label>Longitude</label>
          <input id="home_lng" type="number" step="0.000001" />
        </div>
      </div>

      <div class="cols">
        <div>
          <label>Raio máximo (km)</label>
          <input id="max_dist" type="number" min="1" step="1" />
        </div>
        <div>
          <label>Categorias favoritas (separadas por vírgula)</label>
          <input id="categories" placeholder="bar, pizza, café..." />
        </div>
      </div>

      <button class="btn" id="btnGeo" style="margin-top:10px;background:#111827">Usar minha localização atual</button>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="bar">
        <h2 style="margin:0">Preferências (diferenciais)</h2>
        <button class="btn" id="btnSavePrefs">Salvar preferências</button>
      </div>
      <p class="muted" style="margin-top:-6px">Marque o que você mais gosta e ajuste o peso (+1 a +5).</p>
      <div id="prefs" class="chips"></div>
    </div>
  </div>
</body>
</html>
